import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useExchangeContext } from '../contexts/ExchangeContext';

export type ExchangeOrder = {
  id: number;
  userId: number;
  gameId: string;
  market: string;
  line: number;
  side: 'back' | 'lay';
  price: number;
  amount: number;
  selection?: string; // ÏÑ†ÌÉùÌïú ÌåÄ/ÏÑ†ÏàòÎ™Ö
  status: 'open' | 'matched' | 'settled' | 'cancelled';
  matchedOrderId?: number;
  createdAt: string;
  updatedAt: string;
  homeTeam?: string;
  awayTeam?: string;
  commenceTime?: string;
  sportKey?: string; // Ïä§Ìè¨Ï∏† ÌÇ§ Ï∂îÍ∞Ä
  backOdds?: number;
  layOdds?: number;
};

export interface ExchangeBalance {
  balance: number;
}

export interface OrderForm {
  side: 'back' | 'lay';
  price: number;
  amount: number;
}

export interface SelectedBet {
  team: string;
  price: number;
  type: 'back' | 'lay';
  gameId?: string;
  market?: string;
  line?: number;
  homeTeam?: string; // Ï∂îÍ∞Ä
  awayTeam?: string; // Ï∂îÍ∞Ä
  commenceTime?: string; // Ï∂îÍ∞Ä
}

export const useExchange = () => {
  const { token, balance, setBalance } = useAuth();
  const { selectedBet, setSelectedBet } = useExchangeContext();
  const [orders, setOrders] = useState<ExchangeOrder[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // selectedBet ÏÉÅÌÉú Î≥ÄÍ≤Ω Î°úÍ∑∏
  const setSelectedBetWithLog = (bet: SelectedBet | null) => {
    console.log('setSelectedBet called with:', bet);
    console.log('Previous selectedBet state:', selectedBet);
    setSelectedBet(bet);
    console.log('setSelectedBet state update triggered');
  };

  const headers = {
    'Content-Type': 'application/json',
    'x-auth-token': token || '',
  };

  // ÏûîÍ≥† Ï°∞Ìöå (AuthContextÏùò balance ÏÇ¨Ïö©)
  const fetchBalance = useCallback(async () => {
    if (!token) return;
    
    try {
      // API URL Í≤∞Ï†ï
      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 
                    (typeof window !== 'undefined' && window.location.hostname === 'localhost' 
                     ? 'http://localhost:5050' 
                     : 'https://likebetfair-api.onrender.com');
      
      const response = await fetch(`${apiUrl}/api/exchange/balance`, { headers });
      if (!response.ok) throw new Error('ÏûîÍ≥† Ï°∞Ìöå Ïã§Ìå®');
      
      const data: ExchangeBalance = await response.json();
      setBalance(data.balance);
    } catch (err) {
      console.error('ÏûîÍ≥† Ï°∞Ìöå Ï§ë Ïò§Î•ò:', err);
    }
  }, [token, setBalance]);

  // Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå
  const fetchOrders = useCallback(async () => {
    if (!token) return;
    
    try {
      setLoading(true);
      // API URL Í≤∞Ï†ï
      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 
                    (typeof window !== 'undefined' && window.location.hostname === 'localhost' 
                     ? 'http://localhost:5050' 
                     : 'https://likebetfair-api.onrender.com');
      
      const response = await fetch(`${apiUrl}/api/exchange/orders`, { headers });
      if (!response.ok) throw new Error('Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå Ïã§Ìå®');
      
      const data: ExchangeOrder[] = await response.json();
      console.log('üìã Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå ÏÑ±Í≥µ:', data.length, 'Í∞ú Ï£ºÎ¨∏');
      setOrders(data);
    } catch (err) {
      console.error('‚ùå Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå Ïò§Î•ò:', err);
      setError(err instanceof Error ? err.message : 'Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù');
    } finally {
      setLoading(false);
    }
  }, [token]);

  // Ï£ºÎ¨∏ Îì±Î°ù
  const placeOrder = useCallback(async (orderData: {
    gameId: string;
    market: string;
    line: number;
    side: 'back' | 'lay';
    price: number;
    amount: number;
    selection?: string; // ÏÑ†ÌÉùÌïú ÌåÄ/ÏÑ†ÏàòÎ™Ö
  }) => {
    if (!token) {
      throw new Error('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
    }

    setLoading(true);
    setError(null);

    try {
      console.log('üìù Ï£ºÎ¨∏ ÏÉùÏÑ±:', orderData);
      const response = await fetch('/api/exchange/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(orderData)
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `Ï£ºÎ¨∏ ÏÉùÏÑ± Ïã§Ìå® (${response.status})`);
      }

      const result = await response.json();
      console.log('‚úÖ Ï£ºÎ¨∏ ÏÉùÏÑ± ÏôÑÎ£å:', result);
      
      // Ï£ºÎ¨∏ ÏÑ±Í≥µ ÌõÑ Ï£ºÎ¨∏ ÎÇ¥Ïó≠Í≥º ÏûîÍ≥† ÏÉàÎ°úÍ≥†Ïπ®
      await fetchOrders();
      await fetchBalance();
      
      return result;
    } catch (error) {
      console.error('‚ùå Ï£ºÎ¨∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
      const errorMessage = error instanceof Error ? error.message : 'Ï£ºÎ¨∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      setError(errorMessage);
      throw error;
    } finally {
      setLoading(false);
    }
  }, [token, fetchOrders, fetchBalance]);

  // Îß§Ïπò Ï£ºÎ¨∏ (Í∏∞Ï°¥ Ï£ºÎ¨∏Í≥º Ï¶âÏãú Îß§Ïπ≠ ÏãúÎèÑ)
  const placeMatchOrder = useCallback(async (orderData: {
    gameId: string;
    market: string;
    line: number;
    side: 'back' | 'lay';
    price: number;
    amount: number;
    selection?: string; // ÏÑ†ÌÉùÌïú ÌåÄ/ÏÑ†ÏàòÎ™Ö
  }) => {
    try {
      console.log('üéØ Îß§Ïπò Ï£ºÎ¨∏:', orderData);
      const response = await fetch('/api/exchange/match-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(orderData)
      });

      if (!response.ok) {
        throw new Error('Îß§Ïπò Ï£ºÎ¨∏ Ïã§Ìå®');
      }

      const result = await response.json();
      console.log('‚úÖ Îß§Ïπò Ï£ºÎ¨∏ ÏôÑÎ£å:', result);
      return result;
    } catch (error) {
      console.error('‚ùå Îß§Ïπò Ï£ºÎ¨∏ Ïò§Î•ò:', error);
      throw error;
    }
  }, [token]);

  // Ï£ºÎ¨∏ Ï∑®ÏÜå
  const cancelOrder = useCallback(async (orderId: number) => {
    if (!token) throw new Error('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§');
    
    try {
      setLoading(true);
      // API URL Í≤∞Ï†ï
      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 
                    (typeof window !== 'undefined' && window.location.hostname === 'localhost' 
                     ? 'http://localhost:5050' 
                     : 'https://likebetfair-api.onrender.com');
      
      const response = await fetch(`${apiUrl}/api/exchange/cancel/${orderId}`, {
        method: 'POST',
        headers,
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Ï£ºÎ¨∏ Ï∑®ÏÜå Ïã§Ìå®');
      }
      
      const data = await response.json();
      
      // ÏûîÍ≥† ÏóÖÎç∞Ïù¥Ìä∏ (ÏùëÎãµÏóê Ìè¨Ìï®Îêú Í≤ΩÏö∞)
      if (data.newBalance !== undefined) {
        setBalance(data.newBalance);
      }
      
      // Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Í∞±Ïã†
      await fetchOrders();
      
      return data;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Ï£ºÎ¨∏ Ï∑®ÏÜå Ï§ë Ïò§Î•ò Î∞úÏÉù');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [token, fetchBalance, fetchOrders]);

  // Ìò∏Í∞Ä Ï°∞Ìöå (Í≥µÍ∞ú API - ÌÜ†ÌÅ∞ Î∂àÌïÑÏöî)
  const fetchOrderbook = useCallback(async (
    gameId: string,
    market: string,
    line?: number
  ) => {
    
    try {
      const encodedGameId = encodeURIComponent(gameId);
      const encodedMarket = encodeURIComponent(market);
      const encodedLine = line !== undefined ? encodeURIComponent(line.toString()) : '';
      
      console.log('fetchOrderbook Ìò∏Ï∂ú:', {
        original: { gameId, market, line },
        encoded: { encodedGameId, encodedMarket, encodedLine }
      });
      
      const url = line !== undefined 
        ? `http://localhost:5050/api/exchange/orderbook-test?gameId=${encodedGameId}&market=${encodedMarket}&line=${encodedLine}`
        : `http://localhost:5050/api/exchange/orderbook-test?gameId=${encodedGameId}&market=${encodedMarket}`;
      console.log('fetchOrderbook URL:', url);
      
      const response = await fetch(url, {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log('fetchOrderbook ÏùëÎãµ ÏÉÅÌÉú:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.log('fetchOrderbook ÏóêÎü¨ ÏùëÎãµ:', errorText);
        throw new Error(`Ìò∏Í∞Ä Ï°∞Ìöå Ïã§Ìå®: ${response.status} ${errorText}`);
      }
      
      const data: { orders: ExchangeOrder[] } = await response.json();
      console.log('fetchOrderbook ÏÑ±Í≥µ:', data.orders.length, 'Í∞ú Ï£ºÎ¨∏');
      return data.orders;
    } catch (err) {
      console.error('fetchOrderbook ÏóêÎü¨:', err);
      setError(err instanceof Error ? err.message : 'Ìò∏Í∞Ä Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù');
      return [];
    }
  }, []);

  // Ï†ÑÏ≤¥ Ïò§Ìîà Ï£ºÎ¨∏ Ï°∞Ìöå (Í≥µÍ∞ú API - ÌÜ†ÌÅ∞ Î∂àÌïÑÏöî)
  const fetchAllOpenOrders = useCallback(async () => {
    try {
      // API URL Í≤∞Ï†ï
      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 
                    (typeof window !== 'undefined' && window.location.hostname === 'localhost' 
                     ? 'http://localhost:5050' 
                     : 'https://likebetfair-api.onrender.com');
      
      const response = await fetch(`${apiUrl}/api/exchange/all-orders`, {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Ï†ÑÏ≤¥ Ï£ºÎ¨∏ Ï°∞Ìöå Ïã§Ìå®: ${response.status} ${errorText}`);
      }
      
      const data: ExchangeOrder[] = await response.json();
      console.log('fetchAllOpenOrders ÏÑ±Í≥µ:', data.length, 'Í∞ú Ï£ºÎ¨∏');
      return data;
    } catch (err) {
      console.error('fetchAllOpenOrders ÏóêÎü¨:', err);
      setError(err instanceof Error ? err.message : 'Ï†ÑÏ≤¥ Ï£ºÎ¨∏ Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù');
      return [];
    }
  }, []);

  // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    if (token) {
      fetchBalance();
      fetchOrders();
    }
  }, [token, fetchBalance, fetchOrders]);

  // Exchange Ï£ºÎ¨∏ ÏôÑÎ£å Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleExchangeOrderPlaced = () => {
      if (token) {
        fetchOrders();
        fetchBalance();
      }
    };

    window.addEventListener('exchangeOrderPlaced', handleExchangeOrderPlaced);
    
    return () => {
      window.removeEventListener('exchangeOrderPlaced', handleExchangeOrderPlaced);
    };
  }, [token, fetchOrders, fetchBalance]);

  return {
    balance,
    orders,
    loading,
    error,
    selectedBet,
    setSelectedBet: setSelectedBetWithLog,
    fetchBalance,
    fetchOrders,
    placeOrder,
    placeMatchOrder,
    cancelOrder,
    fetchOrderbook,
    fetchAllOpenOrders,
    clearError: () => setError(null),
  };
}; 